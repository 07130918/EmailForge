'use client';
import type { MailTarget } from '@/types';
import {
    Box,
    Button,
    HStack,
    Input,
    Link,
    Modal,
    ModalBody,
    ModalCloseButton,
    ModalContent,
    ModalHeader,
    ModalOverlay,
    Select,
    Spacer,
    Stack,
    Text,
    Textarea,
    VStack,
    useClipboard,
    useDisclosure,
} from '@chakra-ui/react';
import type { ChangeEvent } from 'react';
import { useState } from 'react';

const samples: MailTarget[] = [
    {
        type: 'sales',
        industry: 'IT',
        age: '20ä»£å¾ŒåŠã‹ã‚‰40ä»£å‰åŠ',
        position: 'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢',
        summary: 'æœ€æ–°ã®ã‚¯ãƒ©ã‚¦ãƒ‰ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã”ç´¹ä»‹',
    },
    {
        type: 'support',
        industry: 'è£½é€ æ¥­',
        age: '30ä»£å¾ŒåŠã‹ã‚‰50ä»£å‰åŠ',
        position: 'è£½å“é–‹ç™ºãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼',
        summary: 'è£½å“ä¸å…·åˆã®ãŠè©«ã³ã¨å¯¾å¿œç­–ã®ã”æ¡ˆå†…',
    },
    {
        type: 'newsletter',
        industry: 'æ•™è‚²',
        age: '30ä»£å‰åŠ',
        position: 'æ•™è‚²ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ',
        summary: 'æœ€æ–°ã®æ•™è‚²æŠ€è¡“ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ¬ãƒãƒ¼ãƒˆ',
    },
];

export default function Home() {
    const [result, setResult] = useState<string>('');
    const [reading = false, setReading] = useState<boolean>(false);
    // ãƒ¡ãƒ¼ãƒ«ã®ç¨®é¡ã®çŠ¶æ…‹ã‚’è¿½è·¡
    const [formState, setFormState] = useState<MailTarget>({
        type: '',
        industry: '',
        age: '',
        position: '',
        summary: '',
    });

    const { isOpen, onOpen, onClose } = useDisclosure();
    const { onCopy, hasCopied } = useClipboard(result);

    const setSample = (sampleData: MailTarget) => {
        setFormState(sampleData);
    };

    const handleChange = (
        e: ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>,
    ) => {
        setFormState({
            ...formState,
            [e.target.name]: e.target.value,
        });
    };

    const handleSubmit = async () => {
        setResult('');
        setReading(true);

        // NOTE: fetchã˜ã‚ƒãªã„ã¨ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å—ã‘å–ã‚Œãªã„
        const response = await fetch('/api/email-text', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formState),
        });
        if (!response.ok || response.body == null) {
            throw new Error('Network error');
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®èª­ã¿å–ã‚Š
        reader.read().then(function processText({ done, value }): Promise<void | undefined> | void {
            if (done) {
                setReading(false);
                return;
            }

            const chunk = decoder.decode(value, { stream: true });
            setResult((prev) => prev + chunk);
            return reader.read().then(processText);
        });
    };

    return (
        <>
            <Modal isOpen={isOpen} onClose={onClose} size='lg'>
                <ModalOverlay />
                <ModalContent bg='#272D33' color='#FFF'>
                    <ModalHeader>å…è²¬äº‹é …</ModalHeader>
                    <ModalCloseButton />
                    <ModalBody maxH='75vh' overflowY='auto'>
                        <Text>
                            This web application provides a service that automatically generates
                            email content based on the information provided by the user, through the
                            API provided by OpenAI.
                        </Text>
                        <Text>
                            No guarantees are made regarding the accuracy, appropriateness, or
                            usefulness of the generated email content or any other content.
                        </Text>
                        <Text>
                            The service and its developers bear no responsibility for any direct or
                            indirect damage, disadvantage, or issues arising from the use of the
                            generated content.
                        </Text>
                        <Text>
                            Users are advised to use the service at their own discretion and risk.
                        </Text>
                        <Text>
                            Content generated by the AI should be considered as a reference only,
                            and users should verify and adjust the content before its final use.
                        </Text>
                        <Text>
                            All responsibilities related to legal issues, third-party rights
                            infringement, or inappropriate expressions in the generated content fall
                            upon the user.
                        </Text>
                        <Text mb={4}>
                            The developers bear no responsibility for any problems arising from the
                            use of this service.
                        </Text>

                        <Box borderBottomWidth='1px' borderBottomColor='white' my={4} />

                        <Text>
                            æœ¬ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸæƒ…å ±ã‚’åŸºã«OpenAIç¤¾ãŒæä¾›ã™ã‚‹APIã‚’é€šã—ã¦ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚
                        </Text>
                        <Text>
                            ç”Ÿæˆã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚„ãã®ä»–ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã¤ã„ã¦ã€ãã®æ­£ç¢ºæ€§ã€é©åˆ‡ã•ã€æœ‰ç”¨æ€§ãªã©ã«é–¢ã—ã¦ä¸€åˆ‡ã®ä¿è¨¼ã‚’è¡Œã†ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                        </Text>
                        <Text>
                            ã¾ãŸã€ç”Ÿæˆã•ã‚ŒãŸå†…å®¹ã‚’åˆ©ç”¨ã—ãŸã“ã¨ã«ã‚ˆã‚‹ç›´æ¥çš„ã¾ãŸã¯é–“æ¥çš„ãªæå®³ã€ä¸åˆ©ç›Šã€ãƒˆãƒ©ãƒ–ãƒ«ãªã©ã«ã¤ã„ã¦ã€å½“ã‚µãƒ¼ãƒ“ã‚¹ãŠã‚ˆã³é–‹ç™ºè€…ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚
                        </Text>
                        <Text>ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã®åˆ¤æ–­ã¨è²¬ä»»ã«ãŠã„ã¦ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚</Text>
                        <Text>
                            AIã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ã€ã‚ãã¾ã§å‚è€ƒç¨‹åº¦ã¨ã—ã¦ãŠè€ƒãˆã„ãŸã ãã€æœ€çµ‚çš„ãªä½¿ç”¨å‰ã«ã¯å†…å®¹ã®ç¢ºèªã¨é©å®œã®ä¿®æ­£ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
                        </Text>
                        <Text>
                            æ³•å¾‹ä¸Šã®å•é¡Œã€ç¬¬ä¸‰è€…ã®æ¨©åˆ©ä¾µå®³ã€ä¸é©åˆ‡ãªè¡¨ç¾ãªã©ã€ç”Ÿæˆã•ã‚ŒãŸå†…å®¹ã«é–¢ã™ã‚‹ä¸€åˆ‡ã®è²¬ä»»ã¯åˆ©ç”¨è€…ã«å¸°å±ã—ã¾ã™ã€‚
                        </Text>
                        <Text>
                            æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã®åˆ©ç”¨ã«ã‚ˆã‚Šç”Ÿã˜ãŸã„ã‹ãªã‚‹å•é¡Œã«ã¤ã„ã¦ã‚‚ã€é–‹ç™ºè€…ã¯è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚
                        </Text>
                    </ModalBody>
                </ModalContent>
            </Modal>

            <Box minH='100vh' bg='#161918'>
                <HStack
                    as='header'
                    width='full'
                    bgGradient='linear(135deg, #00c8ff, #1f7bc2, #00155c)'
                    p={4}
                    justifyContent='space-between'
                    alignItems='center'
                >
                    <Text fontSize='xl' color='white' fontWeight='bold' pl={5}>
                        EmailForge
                    </Text>
                    <Text color='white' pr={5}>
                        Creating awesome emails are not rocket science ğŸš€
                    </Text>
                </HStack>
                <Stack direction={{ base: 'column', md: 'row' }} p={8} spacing={6} align='start'>
                    <VStack spacing={4} flex='1' w='100%'>
                        <Select
                            name='type'
                            placeholder='ãƒ¡ãƒ¼ãƒ«ã®ç¨®é¡ã‚’é¸æŠ'
                            bg='#272D33'
                            color='#F7FAFC'
                            borderColor='#4A5568'
                            value={formState.type}
                            onChange={handleChange}
                        >
                            <option value='sales'>å–¶æ¥­ãƒ¡ãƒ¼ãƒ«</option>
                            <option value='support'>ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µãƒãƒ¼ãƒˆ/ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒ¼ãƒ«</option>
                            <option value='newsletter'>ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ¬ã‚¿ãƒ¼</option>
                            <option value='thankYou'>æ„Ÿè¬ã‚„ç¥è³€ã®ãƒ¡ãƒ¼ãƒ«</option>
                            <option value='invitation'>æ‹›å¾…ãƒ¡ãƒ¼ãƒ«</option>
                            <option value='other'>ãã®ä»–</option>
                        </Select>
                        {formState.type === 'other' && (
                            <Input
                                name='mailType'
                                placeholder='ãƒ¡ãƒ¼ãƒ«ã®ç¨®é¡ã‚’å…¥åŠ›'
                                bg='#272D33'
                                color='#FFF'
                                borderColor='#4A5568'
                                value={formState.type}
                                onChange={handleChange}
                            />
                        )}
                        <Input
                            name='industry'
                            placeholder='æ¥­ç•Œ(ä¾‹: ITã€é‡‘èã€è£½é€ æ¥­)'
                            bg='#272D33'
                            color='#FFF'
                            borderColor='#4A5568'
                            value={formState.industry}
                            onChange={handleChange}
                        />
                        <Input
                            name='age'
                            placeholder='å¹´é½¢ (ä¾‹: 20ä»£å¾ŒåŠã‹ã‚‰30ä»£å‰åŠ)'
                            bg='#272D33'
                            color='#FFF'
                            borderColor='#4A5568'
                            value={formState.age}
                            onChange={handleChange}
                        />
                        <Input
                            name='position'
                            placeholder='å—ä¿¡è€…ã®å½¹è·/å±æ€§ï¼ˆä¾‹ï¼šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã€ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã€å­¦ç”Ÿï¼‰'
                            bg='#272D33'
                            color='#FFF'
                            borderColor='#4A5568'
                            value={formState.position}
                            onChange={handleChange}
                        />
                        <Textarea
                            name='summary'
                            placeholder='ãƒ¡ãƒ¼ãƒ«ã®æ¦‚è¦ã‚’ç°¡æ½”ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'
                            bg='#272D33'
                            color='#FFF'
                            borderColor='#4A5568'
                            resize='none'
                            rows={4}
                            value={formState.summary}
                            onChange={handleChange}
                        />
                        <HStack w='full'>
                            <Spacer />
                            <Button
                                colorScheme='gray'
                                isDisabled={reading}
                                size='lg'
                                onClick={handleSubmit}
                            >
                                ç”Ÿæˆã™ã‚‹
                            </Button>
                        </HStack>
                        <Box borderColor='#4A5568' bg='#272D33' p={4} borderRadius='md' w='100%'>
                            <Text color='#FFF' pb={4}>
                                ã‚µãƒ³ãƒ—ãƒ«ã‹ã‚‰ç”Ÿæˆã™ã‚‹
                            </Text>
                            {samples.map((sample, i) => (
                                <Button
                                    key={i}
                                    colorScheme='teal'
                                    minH={12}
                                    w='100%'
                                    onClick={() => setSample(sample)}
                                    my={1}
                                >
                                    <Text>{sample.summary}</Text>
                                </Button>
                            ))}
                        </Box>
                    </VStack>
                    <Box flex='1' borderColor='#4A5568' bg='#272D33' p={4} borderRadius='md'>
                        <HStack borderColor='#4A5568'>
                            <Text fontSize='lg' fontWeight='bold' color='#FFF'>
                                ç”Ÿæˆçµæœ:
                            </Text>
                            <Spacer />
                            <Button onClick={onCopy}>{hasCopied ? 'Copied!' : 'Copy'}</Button>
                        </HStack>
                        <Text whiteSpace='pre-wrap' color='#FFF'>
                            {result}
                        </Text>
                    </Box>
                </Stack>
                <Box mt={20} py={4} borderColor='#FFF' borderTopWidth='1px' bg='#161918'>
                    <HStack spacing={4} justifyContent='flex-start' pl={4}>
                        <Link
                            href='https://hi-there-this-is-kota.vercel.app'
                            isExternal
                            color='#FFF'
                            fontSize='sm'
                            _hover={{ color: '#00c8ff' }}
                        >
                            Developer&apos;s Website
                        </Link>
                        <Link
                            href='https://github.com/07130918/EmailForge/issues/new'
                            isExternal
                            color='#FFF'
                            fontSize='sm'
                            _hover={{ color: '#00c8ff' }}
                        >
                            Report a Bug
                        </Link>
                        <Button
                            color='#FFF'
                            variant='ghost'
                            size='sm'
                            _hover={{ color: '#00c8ff' }}
                            onClick={onOpen}
                        >
                            å…è²¬äº‹é …/Disclaimer
                        </Button>
                    </HStack>
                </Box>
            </Box>
        </>
    );
}
